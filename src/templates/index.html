<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reconhecimento Facial para Ponto dos volunt√°rios do hospital do Cajuru</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/app.css') }}" />
    <meta name="color-scheme" content="light">
    <meta name="theme-color" content="#b00020">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow">
</head>
<body>
    <header class="header">
        <div class="title">Reconhecimento Facial para Ponto dos volunt√°rios do hospital do Cajuru</div>
    </header>
    <main class="container">
        <section class="panel">
            <div class="video-wrap" style="position: relative;">
                <div class="camera-status loading" id="camera-status">Inicializando c√¢mera...</div>
                <video id="video-stream" autoplay playsinline></video>
                <img id="processed-frame" alt="frame processado" />
                <canvas id="canvas" style="display:none;"></canvas>
                <div class="stability-wrap" id="stability-wrap">
                    <div class="stability">
                        <div class="text" id="stability-text">Mantenha-se parado...</div>
                        <div class="bar"><div class="fill" id="stability-fill"></div></div>
                    </div>
                </div>
            </div>

            <div class="instructions">
                <h3>Instru√ß√µes</h3>
                <ul>
                    <li>Posicione seu rosto centralizado e vis√≠vel pela c√¢mera.</li>
                    <li>Mantenha-se a aproximadamente 50‚Äì70 cm do dispositivo.</li>
                    <li>Prefira um ambiente com boa ilumina√ß√£o frontal.</li>
                    <li>Se voc√™ ainda n√£o possui cadastro, clique no bot√£o abaixo.</li>
                    <li>Se voc√™ j√° possui cadastro, mas n√£o consegue ser reconhecido, clique no bot√£o abaixo.</li>
                </ul>
            </div>

            <div class="actions">
                <a class="btn" href="{{ url_for('registro') }}">Ir para cadastro de rosto</a>
            </div>
        </section>
    </main>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal-backdrop" id="confirm-modal">
        <div class="modal">
            <header>Confirmar registro de ponto</header>
            <div class="content">
                <div class="row"><strong>Nome:</strong> <span id="m-nome">-</span></div>
                <div class="row"><strong>CPF:</strong> <span id="m-cpf">-</span></div>
                <div class="row"><strong>Matr√≠cula:</strong> <span id="m-mat">-</span></div>
                <div class="row"><strong>Hor√°rio:</strong> <span id="m-hora">-</span> <span class="muted" id="m-conf"></span></div>
                <div class="row muted">Confira seus dados e confirme para registrar seu ponto.</div>
                <div id="m-status" class="muted"></div>
            </div>
            <footer>
                <button class="btn secondary" id="btn-cancelar">Cancelar</button>
                <button class="btn" id="btn-confirmar">Confirmar</button>
            </footer>
        </div>
    </div>

    <footer class="footer">
        <div class="inner">Hospital do Cajuru ‚Äî Reconhecimento facial para registro de ponto</div>
    </footer>

    <script>
        // Inicializa c√¢mera do dispositivo
        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isProcessing = false;

        // Detecta sistema operacional e navegador
        const userAgent = navigator.userAgent;
        const isAndroid = /Android/i.test(userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
        const isMobile = isAndroid || isIOS || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
        const isChrome = /Chrome/i.test(userAgent) && /Google Inc/.test(navigator.vendor);
        const isSafari = /Safari/i.test(userAgent) && /Apple Computer/.test(navigator.vendor);
        
        // Verifica se est√° usando HTTPS (obrigat√≥rio para mobile)
        const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        console.log('=== INFO DO DISPOSITIVO ===');
        console.log(`üì± Mobile: ${isMobile}`);
        console.log(`ü§ñ Android: ${isAndroid}`);
        console.log(`üçé iOS: ${isIOS}`);
        console.log(`üåê Navegador: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : 'Outro'}`);
        console.log(`üîí HTTPS: ${isSecure}`);
        console.log(`üåç URL: ${window.location.href}`);
        
        if (isMobile && !isSecure) {
            console.warn('‚ö†Ô∏è AVISO: Mobile requer HTTPS para acesso √† c√¢mera!');
            console.warn('üí° Use ngrok ou acesse via HTTPS');
        }

        // Lista c√¢meras dispon√≠veis (para debug)
        async function listCameras() {
            try {
                console.log('üîç Verificando dispositivos de m√≠dia...');
                
                if (!navigator.mediaDevices) {
                    console.error('‚ùå navigator.mediaDevices n√£o est√° dispon√≠vel');
                    return [];
                }
                
                if (!navigator.mediaDevices.enumerateDevices) {
                    console.error('‚ùå enumerateDevices n√£o est√° dispon√≠vel');
                    return [];
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                console.log(`‚úÖ Total de dispositivos: ${devices.length}`);
                console.log(`üìπ C√¢meras de v√≠deo: ${videoDevices.length}`);
                
                if (videoDevices.length > 0) {
                    videoDevices.forEach((device, index) => {
                        console.log(`  üìπ C√¢mera ${index + 1}: ${device.label || 'Sem nome'}`);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Nenhuma c√¢mera encontrada. Pode ser necess√°rio dar permiss√£o primeiro.');
                }
                
                return videoDevices;
            } catch (err) {
                console.error('‚ùå Erro ao listar c√¢meras:', err.name, '-', err.message);
                return [];
            }
        }

        // Configura√ß√£o da c√¢mera
        async function initCamera() {
            const statusEl = document.getElementById('camera-status');
            
            // Verifica suporte
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('getUserMedia n√£o dispon√≠vel');
                statusEl.textContent = '‚úó Navegador n√£o suporta c√¢mera';
                statusEl.className = 'camera-status error';
                video.style.display = 'none';
                const errorMsg = document.createElement('div');
                errorMsg.style.padding = '20px';
                errorMsg.style.color = '#b00020';
                errorMsg.style.textAlign = 'center';
                errorMsg.innerHTML = `
                    <strong>Navegador n√£o suporta acesso √† c√¢mera</strong><br>
                    <small>Use Chrome, Firefox ou Safari atualizado</small>
                `;
                document.querySelector('.video-wrap').appendChild(errorMsg);
                return;
            }
            
            // Verifica HTTPS em mobile
            if (isMobile && !isSecure) {
                console.error('‚ùå Mobile requer HTTPS!');
                statusEl.textContent = '‚úó HTTPS necess√°rio';
                statusEl.className = 'camera-status error';
                video.style.display = 'none';
                const errorMsg = document.createElement('div');
                errorMsg.style.padding = '20px';
                errorMsg.style.color = '#b00020';
                errorMsg.style.textAlign = 'center';
                errorMsg.innerHTML = `
                    <strong>HTTPS obrigat√≥rio para c√¢mera no celular</strong><br>
                    <small>Acesse via HTTPS ou use ferramentas como ngrok</small><br>
                    <small style="margin-top:10px; display:block;">URL atual: ${window.location.href}</small>
                `;
                document.querySelector('.video-wrap').appendChild(errorMsg);
                return;
            }
            
            try {
                statusEl.textContent = 'Solicitando permiss√£o...';
                statusEl.className = 'camera-status loading';
                
                console.log('üé• Iniciando acesso √† c√¢mera...');
                console.log(`üì± Dispositivo: ${isMobile ? 'MOBILE' : 'DESKTOP'}`);
                
                let constraints;
                
                if (isMobile) {
                    // Mobile: configura√ß√µes espec√≠ficas por plataforma
                    if (isIOS) {
                        // iOS - configura√ß√£o espec√≠fica
                        constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 640, max: 1280 },
                                height: { ideal: 480, max: 720 }
                            },
                            audio: false
                        };
                        console.log('üçé Usando configura√ß√£o iOS');
                    } else {
                        // Android
                        constraints = {
                            video: {
                                facingMode: { exact: 'user' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            },
                            audio: false
                        };
                        console.log('ü§ñ Usando configura√ß√£o Android');
                    }
                } else {
                    // Desktop: usa qualquer c√¢mera dispon√≠vel
                    constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    console.log('üíª Usando configura√ß√£o DESKTOP (c√¢mera padr√£o)');
                }
                
                console.log('‚è≥ Aguardando permiss√£o do usu√°rio...');
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await video.play();
                
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                console.log('‚úÖ C√¢mera inicializada com sucesso!');
                console.log(`üìê Resolu√ß√£o: ${settings.width}x${settings.height}`);
                console.log(`üé¨ FPS: ${settings.frameRate || 'N/A'}`);
                
                statusEl.textContent = '‚úì C√¢mera ativa';
                statusEl.className = 'camera-status active';
                setTimeout(() => statusEl.style.display = 'none', 3000);
                
                console.log('C√¢mera inicializada com sucesso');
                startFrameProcessing();
                
            } catch (err) {
                console.error('‚ùå ERRO ao acessar c√¢mera:', err.name, '-', err.message);
                statusEl.textContent = `Erro: ${err.name}`;
                statusEl.className = 'camera-status error';
                
                // Tenta fallback com configura√ß√µes m√≠nimas
                try {
                    console.log('üîÑ Tentando configura√ß√£o alternativa (fallback)...');
                    statusEl.textContent = 'Tentando modo b√°sico...';
                    statusEl.className = 'camera-status loading';
                    
                    let fallbackConstraints;
                    
                    // Para mobile, tenta sem 'exact'
                    if (isMobile) {
                        fallbackConstraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            },
                            audio: false
                        };
                        console.log('üì± Tentando mobile com resolu√ß√£o menor...');
                    } else {
                        fallbackConstraints = { 
                            video: true,
                            audio: false
                        };
                        console.log('üíª Tentando desktop modo b√°sico...');
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    video.srcObject = stream;
                    await video.play();
                    
                    const track = stream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log('‚úÖ C√¢mera inicializada com configura√ß√£o b√°sica!');
                    console.log(`üìê Resolu√ß√£o: ${settings.width}x${settings.height}`);
                    
                    statusEl.textContent = '‚úì C√¢mera ativa (modo b√°sico)';
                    statusEl.className = 'camera-status active';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    
                    console.log('C√¢mera inicializada com configura√ß√£o b√°sica');
                    startFrameProcessing();
                } catch (fallbackErr) {
                    console.error('‚ùå FALHA COMPLETA:', fallbackErr.name, '-', fallbackErr.message);
                    
                    // √öltima tentativa: apenas video: true
                    try {
                        console.log('üîÑ √öltima tentativa: configura√ß√£o m√≠nima absoluta...');
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.srcObject = stream;
                        await video.play();
                        
                        console.log('‚úÖ Funcionou com configura√ß√£o m√≠nima!');
                        statusEl.textContent = '‚úì C√¢mera ativa';
                        statusEl.className = 'camera-status active';
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                        startFrameProcessing();
                    } catch (finalErr) {
                        console.error('‚ùå TODAS AS TENTATIVAS FALHARAM:', finalErr.name, '-', finalErr.message);
                        video.style.display = 'none';
                        statusEl.textContent = '‚úó Falha ao acessar c√¢mera';
                        statusEl.className = 'camera-status error';
                        
                        const errorMsg = document.createElement('div');
                        errorMsg.style.padding = '20px';
                        errorMsg.style.color = '#b00020';
                        errorMsg.style.textAlign = 'center';
                        
                        let errorDetails = `<strong>N√£o foi poss√≠vel acessar a c√¢mera</strong><br>`;
                        errorDetails += `<small><strong>Erro:</strong> ${finalErr.name}</small><br>`;
                        errorDetails += `<small>${finalErr.message}</small><br>`;
                        
                        if (finalErr.name === 'NotAllowedError') {
                            errorDetails += `<br><strong>Solu√ß√£o:</strong> Permita o acesso √† c√¢mera nas configura√ß√µes do navegador`;
                        } else if (finalErr.name === 'NotFoundError') {
                            errorDetails += `<br><strong>Solu√ß√£o:</strong> Nenhuma c√¢mera encontrada`;
                        } else if (finalErr.name === 'NotReadableError') {
                            errorDetails += `<br><strong>Solu√ß√£o:</strong> C√¢mera em uso por outro app. Feche outros aplicativos.`;
                        } else if (finalErr.name === 'OverconstrainedError') {
                            errorDetails += `<br><strong>Solu√ß√£o:</strong> Configura√ß√£o n√£o suportada pela c√¢mera`;
                        }
                        
                        if (isMobile && !isSecure) {
                            errorDetails += `<br><br><strong style="color:#d32f2f;">‚ö†Ô∏è Mobile requer HTTPS!</strong>`;
                        }
                        
                        errorDetails += `<br><small style="display:block; margin-top:10px;">Abra o Console (F12) para mais detalhes</small>`;
                        
                        errorMsg.innerHTML = errorDetails;
                        document.querySelector('.video-wrap').appendChild(errorMsg);
                    }
                }
            }
        }

        // Inicia c√¢mera
        // Aguarda o DOM estar completamente carregado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => listCameras().then(() => initCamera()), 100);
            });
        } else {
            setTimeout(() => listCameras().then(() => initCamera()), 100);
        }

        // Envia frames para processamento
        async function startFrameProcessing() {
            setInterval(async () => {
                if (isProcessing || !video.videoWidth || !video.videoHeight) return;
                isProcessing = true;

                try {
                    // Captura frame do v√≠deo
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    // Converte para base64
                    const frameData = canvas.toDataURL('image/jpeg', 0.8);

                    // Envia para servidor
                    const response = await fetch('/api/process_frame', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ frame: frameData })
                    });

                    const data = await response.json();
                    
                    if (!data.success) {
                        console.error('Erro ao processar frame:', data.message);
                    }
                    // Atualiza overlay de bounding boxes
                    const processedImg = document.getElementById('processed-frame');
                    if (data.processed_frame) {
                        processedImg.src = data.processed_frame;
                    }
                    // Atualiza barra de estabilidade
                    const ui = data.ui || {};
                    const wrap = document.getElementById('stability-wrap');
                    const fill = document.getElementById('stability-fill');
                    const text = document.getElementById('stability-text');
                    if (ui.tracking) {
                        const pct = Math.max(0, Math.min(1, ui.progress || 0));
                        fill.style.width = (pct * 100).toFixed(0) + '%';
                        const secs = (ui.secondsLeft != null) ? ui.secondsLeft.toFixed(1) : '';
                        text.textContent = secs ? `Segure firme por mais ${secs}s` : 'Segure firme...';
                        wrap.style.display = 'block';
                    } else {
                        wrap.style.display = 'none';
                        fill.style.width = '0%';
                    }
                } catch (err) {
                    console.error('Erro ao processar frame:', err);
                } finally {
                    isProcessing = false;
                }
            }, 100); // Processa ~10 fps
        }

        // Modal helpers
        const modal = document.getElementById('confirm-modal');
        const mNome = document.getElementById('m-nome');
        const mCpf = document.getElementById('m-cpf');
        const mMat = document.getElementById('m-mat');
        const mHora = document.getElementById('m-hora');
        const mConf = document.getElementById('m-conf');
        const mStatus = document.getElementById('m-status');
        let detCache = null;

        function openModal(det){
            mNome.textContent = det.nome;
            mCpf.textContent = det.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            mMat.textContent = det.matricula;
            mHora.textContent = new Date(det.horario).toLocaleString('pt-BR');
            mConf.textContent = det.confidence != null ? `(confian√ßa: ${det.confidence.toFixed(1)})` : '';
            mStatus.textContent = '';
            modal.style.display = 'flex';
        }
        function closeModal(){ modal.style.display = 'none'; detCache = null; }

        // Polling da √∫ltima detec√ß√£o para exibir popup
        async function pollDetection(){
            try{
                const r = await fetch('/api/last_detection');
                const data = await r.json();
                if(data && data.found){ detCache = data; openModal(data); }
            }catch(err){ /* silencioso */ }
        }
        setInterval(pollDetection, 1200);

        // A√ß√µes modal
        document.getElementById('btn-cancelar').onclick = closeModal;
        document.getElementById('btn-confirmar').onclick = async function(){
            if(!detCache){ return; }
            try{
                mStatus.textContent = 'Registrando...';
                const btnConfirm = document.getElementById('btn-confirmar');
                const btnCancel = document.getElementById('btn-cancelar');
                btnConfirm.disabled = true; btnCancel.disabled = true;
                const r = await fetch('/api/confirmar_ponto', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ cpf: detCache.cpf, confidence: detCache.confidence, detection_id: detCache.detection_id })
                });
                if(!r.ok){
                    const text = await r.text();
                    mStatus.textContent = `Falha (${r.status}). ${text || 'Resposta inv√°lida do servidor.'}`;
                    btnConfirm.disabled = false; btnCancel.disabled = false;
                    return;
                }
                let resp;
                try { resp = await r.json(); }
                catch(parseErr){
                    mStatus.textContent = 'Resposta inv√°lida do servidor (JSON).';
                    btnConfirm.disabled = false; btnCancel.disabled = false;
                    return;
                }
                if(resp && resp.success){
                    mStatus.textContent = 'Ponto registrado com sucesso!';
                    setTimeout(closeModal, 1000);
                }else{
                    mStatus.textContent = (resp && resp.message) ? resp.message : 'Falha ao registrar ponto.';
                    btnConfirm.disabled = false; btnCancel.disabled = false;
                }
            }catch(err){
                mStatus.textContent = 'Problema de conex√£o ao enviar dados.';
                const btnConfirm = document.getElementById('btn-confirmar');
                const btnCancel = document.getElementById('btn-cancelar');
                btnConfirm.disabled = false; btnCancel.disabled = false;
            }
        };
    </script>
</body>
</html>