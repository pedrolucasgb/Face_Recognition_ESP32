<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Rostos - Volunt√°rios Cajuru</title>
    <style>
        :root { --red:#b00020; --red-dark:#8a0019; --border:#e6e6e6; --gray:#444; --muted:#777; }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: Arial, Helvetica, sans-serif; background:#fff; color: var(--gray); }
        header, footer { background: var(--red); color:#fff; padding:16px 24px; }
        header .title, footer .inner { max-width:1100px; margin:0 auto; font-weight:600; }
        footer { font-size:13px; opacity:.9; }
        main { max-width:1100px; margin:24px auto 40px; padding:0 16px; }
        .grid { display:grid; gap:24px; grid-template-columns:1fr 1fr; }
        @media (max-width:860px){ .grid { grid-template-columns:1fr; } }
        .panel { border:1px solid var(--border); border-radius:6px; background:#fff; padding:16px 18px; }
        h2 { font-size:18px; margin-bottom:12px; font-weight:600; }
        form .group { margin-bottom:14px; }
        label { display:block; font-size:13px; font-weight:600; margin-bottom:6px; }
        input { width:100%; padding:10px 12px; font-size:14px; border:1px solid var(--border); border-radius:4px; }
        input:focus { outline:2px solid var(--red); border-color: var(--red); }
        .actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
        .btn { cursor:pointer; border:1px solid var(--red); background: var(--red); color:#fff; padding:10px 18px; font-size:14px; border-radius:4px; text-decoration:none; }
        .btn.secondary { background:#fff; color: var(--red); }
        .btn:disabled { opacity:.55; cursor:not-allowed; }
        .btn:hover:not(:disabled) { background: var(--red-dark); border-color: var(--red-dark); }
        .status { margin-top:12px; font-size:13px; padding:10px 12px; border-radius:4px; border:1px solid var(--border); background:#fafafa; }
        .status.error { border-color:#d93025; color:#b00020; background:#fff5f5; }
        .status.success { border-color:#0f7b39; color:#0f5226; background:#f3fff6; }
        .step-indicator { font-size:13px; margin-bottom:12px; color: var(--muted); }
        .video-wrap { border:1px solid var(--border); border-radius:6px; overflow:hidden; background:#000; position: relative; }
        #video-stream { width:100%; display:block; transform: scaleX(-1); }
        .camera-status { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 12px; z-index: 10; }
        .camera-status.loading { background: rgba(255,152,0,0.9); }
        .camera-status.active { background: rgba(76,175,80,0.9); }
        .camera-status.error { background: rgba(244,67,54,0.9); }
        .instructions { margin-top:14px; font-size:13px; color: var(--muted); }
        .instructions ul { margin-left:18px; line-height:1.5; }
        .capture-count { margin-top:10px; font-size:13px; color: var(--muted); }
        .list-reg { margin-top:18px; max-height:240px; overflow-y:auto; border:1px solid var(--border); border-radius:6px; }
        .list-item { display:flex; justify-content:space-between; padding:8px 12px; font-size:13px; border-bottom:1px solid var(--border); }
        .list-item:last-child { border-bottom:none; }
        .list-item span.meta { color: var(--muted); }
        /* Loading / progress overlay */
        .overlay-training { position:fixed; inset:0; background:rgba(255,255,255,0.85); backdrop-filter:blur(2px); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; font-family:inherit; }
        .overlay-training.hidden { display:none; }
        .overlay-training h3 { font-size:18px; margin-bottom:18px; font-weight:600; color: var(--gray); text-align:center; }
        .progress-track { width:320px; max-width:80vw; height:10px; background:#eee; border-radius:6px; overflow:hidden; position:relative; box-shadow:0 0 0 1px #ddd inset; }
        .progress-bar { position:absolute; inset:0; background: linear-gradient(90deg, var(--red) 0%, #ff6b6b 50%, var(--red) 100%); background-size:200% 100%; animation: indet 1.2s linear infinite; }
        @keyframes indet { 0% { transform:translateX(-100%); } 50% { transform:translateX(0); } 100% { transform:translateX(100%); } }
        .training-msg { margin-top:14px; font-size:14px; color: var(--muted); text-align:center; }
    </style>
    <meta name="color-scheme" content="light">
</head>
<body>
    <header>
        <div class="title">Cadastro de Rostos ‚Äî Volunt√°rios Hospital do Cajuru</div>
    </header>
    <main>
        <div id="overlay-training" class="overlay-training hidden" aria-hidden="true">
            <h3>Atualizando modelo de reconhecimento</h3>
            <div class="progress-track"><div class="progress-bar"></div></div>
            <div class="training-msg" id="training-text">Isso pode levar alguns segundos dependendo da quantidade de imagens...</div>
            <button type="button" class="btn secondary" id="btn-cancel-train" style="margin-top:22px; display:none;" disabled>Cancelar</button>
        </div>
        <div class="step-indicator" id="etapa">Etapa 1 de 2 ‚Äî Dados do volunt√°rio</div>
        <div class="grid">
            <section class="panel" id="form-panel">
                <h2>Dados do Volunt√°rio</h2>
                <form id="form-cadastro" autocomplete="off">
                    <div class="group">
                        <label for="nome-pessoa">Nome completo *</label>
                        <input id="nome-pessoa" name="nome" required placeholder="Fulano de Tal" />
                    </div>
                    <div class="group">
                        <label for="cpf-pessoa">CPF *</label>
                        <input id="cpf-pessoa" name="cpf" required maxlength="14" placeholder="000.000.000-00" />
                    </div>
                    <div class="group">
                        <label for="matricula-pessoa">Matr√≠cula *</label>
                        <input id="matricula-pessoa" name="matricula" required placeholder="Identificador interno" />
                    </div>
                    <div class="group">
                        <label for="email-pessoa">Email (opcional)</label>
                        <input id="email-pessoa" name="email" type="email" placeholder="email@exemplo.com" />
                    </div>
                </form>
                <div class="actions">
                    <button class="btn" id="btn-verificar" type="button">Verificar / Continuar</button>
                    <button class="btn secondary" id="btn-reset" type="button" style="display:none;">Novo cadastro</button>
                </div>
                <div id="status-messages"></div>
            </section>
            <section class="panel" id="capture-panel" style="display:none;">
                <h2>Captura de Fotos</h2>
                <div class="video-wrap">
                    <div class="camera-status loading" id="camera-status" style="display:none;">Inicializando c√¢mera...</div>
                    <video id="video-stream" autoplay playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div class="instructions">
                    <ul>
                        <li>Mantenha o rosto centralizado e bem iluminado.</li>
                        <li>Evite sombras fortes ou contraluz.</li>
                        <li>Capture diversas fotos variando levemente √¢ngulo e express√£o.</li>
                        <li>Recomendado: 10‚Äì15 fotos para melhor qualidade.</li>
                    </ul>
                </div>
                <div class="actions">
                    <button class="btn" id="btn-capturar" type="button" disabled>Capturar Foto</button>
                    <button class="btn secondary" id="btn-finalizar" type="button" disabled>Finalizar</button>
                </div>
                <div class="capture-count" id="capture-counter">Nenhuma foto capturada ainda.</div>
            </section>
        </div>
        <section class="panel" style="margin-top:24px;">
            <h2>Registros Existentes</h2>
            <div id="pessoas-lista" class="list-reg">
                <div class="list-item"><span>Carregando...</span></div>
            </div>
        </section>
        <div style="margin-top:16px;">
            <a href="{{ url_for('index') }}" class="btn secondary">Voltar para reconhecimento</a>
        </div>
    </main>
    <footer>
        <div class="inner">Hospital do Cajuru ‚Äî Sistema de reconhecimento (captura de rostos)</div>
    </footer>

    <script>
        let usuarioAtualId = null;
        let cpfAtual = null;
        let fotosCapturadas = 0;
        let etapa = 1;
        let isProcessing = false;

        // Elementos da c√¢mera
        const video = document.getElementById('video-stream');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Detecta sistema operacional e navegador
        const userAgent = navigator.userAgent;
        const isAndroid = /Android/i.test(userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
        const isMobile = isAndroid || isIOS || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
        const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        console.log('=== INFO DO DISPOSITIVO (Registro) ===');
        console.log(`üì± Mobile: ${isMobile}`);
        console.log(`ü§ñ Android: ${isAndroid}`);
        console.log(`üçé iOS: ${isIOS}`);
        console.log(`üîí HTTPS: ${isSecure}`);

        // Lista c√¢meras dispon√≠veis (para debug)
        async function listCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                console.log('C√¢meras dispon√≠veis:', videoDevices);
                return videoDevices;
            } catch (err) {
                console.error('Erro ao listar c√¢meras:', err);
                return [];
            }
        }

        // Inicializa c√¢mera quando chegar na etapa 2
        async function initCamera() {
            const statusEl = document.getElementById('camera-status');
            statusEl.style.display = 'block';
            
            // Verifica suporte
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('getUserMedia n√£o dispon√≠vel');
                statusEl.textContent = '‚úó Navegador n√£o suporta c√¢mera';
                statusEl.className = 'camera-status error';
                showMessage('Seu navegador n√£o suporta acesso √† c√¢mera. Use Chrome, Firefox ou Safari atualizado.', 'error');
                return;
            }
            
            // Verifica HTTPS em mobile
            if (isMobile && !isSecure) {
                console.error('‚ùå Mobile requer HTTPS!');
                statusEl.textContent = '‚úó HTTPS necess√°rio';
                statusEl.className = 'camera-status error';
                showMessage('HTTPS obrigat√≥rio para c√¢mera no celular. Acesse via HTTPS ou use ngrok.', 'error');
                return;
            }
            
            try {
                statusEl.textContent = 'Solicitando permiss√£o...';
                statusEl.className = 'camera-status loading';
                
                // Lista c√¢meras primeiro
                await listCameras();
                
                let constraints;
                
                if (isMobile) {
                    // Mobile: configura√ß√µes espec√≠ficas por plataforma
                    if (isIOS) {
                        constraints = {
                            video: {
                                facingMode: 'user',
                                width: { ideal: 640, max: 1280 },
                                height: { ideal: 480, max: 720 }
                            },
                            audio: false
                        };
                        console.log('üçé Usando configura√ß√£o iOS (registro)');
                    } else {
                        constraints = {
                            video: {
                                facingMode: { exact: 'user' },
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            },
                            audio: false
                        };
                        console.log('ü§ñ Usando configura√ß√£o Android (registro)');
                    }
                } else {
                    // Desktop: usa qualquer c√¢mera dispon√≠vel
                    constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    console.log('üíª Usando configura√ß√£o DESKTOP (registro)');
                }

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await video.play();
                
                statusEl.textContent = '‚úì C√¢mera ativa';
                statusEl.className = 'camera-status active';
                setTimeout(() => statusEl.style.display = 'none', 3000);
                
                console.log('C√¢mera inicializada com sucesso');
                startFrameProcessing();
                
            } catch (err) {
                console.error('‚ùå ERRO ao acessar c√¢mera:', err.name, '-', err.message);
                statusEl.textContent = `Erro: ${err.name}`;
                statusEl.className = 'camera-status error';
                
                // Tenta fallback com configura√ß√µes m√≠nimas
                try {
                    console.log('üîÑ Tentando configura√ß√£o alternativa...');
                    statusEl.textContent = 'Tentando modo b√°sico...';
                    statusEl.className = 'camera-status loading';
                    
                    let fallbackConstraints;
                    if (isMobile) {
                        fallbackConstraints = {
                            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                            audio: false
                        };
                    } else {
                        fallbackConstraints = { video: true, audio: false };
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    video.srcObject = stream;
                    await video.play();
                    
                    statusEl.textContent = '‚úì C√¢mera ativa (modo b√°sico)';
                    statusEl.className = 'camera-status active';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                    
                    console.log('C√¢mera inicializada com configura√ß√£o b√°sica');
                    startFrameProcessing();
                } catch (fallbackErr) {
                    console.error('‚ùå Fallback falhou:', fallbackErr.name);
                    
                    // √öltima tentativa
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.srcObject = stream;
                        await video.play();
                        statusEl.textContent = '‚úì C√¢mera ativa';
                        statusEl.className = 'camera-status active';
                        setTimeout(() => statusEl.style.display = 'none', 3000);
                        startFrameProcessing();
                    } catch (finalErr) {
                        console.error('‚ùå TODAS AS TENTATIVAS FALHARAM');
                        statusEl.textContent = '‚úó Falha ao acessar c√¢mera';
                        statusEl.className = 'camera-status error';
                        
                        let errorMsg = `Erro ao acessar c√¢mera: ${finalErr.name}`;
                        if (isMobile && !isSecure) errorMsg += ' (HTTPS necess√°rio no mobile)';
                        showMessage(errorMsg, 'error');
                    }
                }
            }
        }

        // Processa frames continuamente
        async function startFrameProcessing() {
            setInterval(async () => {
                if (isProcessing || etapa !== 2 || !video.videoWidth || !video.videoHeight) return;
                
                try {
                    // Captura frame do v√≠deo
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    
                    // Converte para base64
                    const frameData = canvas.toDataURL('image/jpeg', 0.8);

                    // Envia para servidor
                    const response = await fetch('/api/process_frame_registro', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ frame: frameData })
                    });

                    const data = await response.json();
                    
                    if (!data.success) {
                        console.error('Erro ao processar frame:', data.message);
                    }
                } catch (err) {
                    console.error('Erro ao processar frame:', err);
                }
            }, 150); // ~6-7 fps
        }

        // M√°scara para CPF
        document.getElementById('cpf-pessoa').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g,'').slice(0,11);
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = v;
        });

        // Carrega pessoas registradas
        async function loadPessoasRegistradas() {
            try {
                const response = await fetch('/api/pessoas_registradas');
                const pessoas = await response.json();
                const container = document.getElementById('pessoas-lista');
                
                if (pessoas.length > 0) {
                    container.innerHTML = pessoas.map(pessoa => 
                        `<div class="pessoa-item">
                            <div>
                                <span class="pessoa-nome">${pessoa.nome}</span><br>
                                <small style="color: #666;">CPF: ${formatCPF(pessoa.cpf)} | Matr√≠cula: ${pessoa.matricula}</small>
                            </div>
                            <span class="pessoa-count">${pessoa.imagens} fotos</span>
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="status-message status-info">Nenhuma pessoa registrada ainda</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar pessoas:', error);
                document.getElementById('pessoas-lista').innerHTML = 
                    '<div class="status-message status-error">Erro ao carregar pessoas registradas</div>';
            }
        }

        // Formata CPF para exibi√ß√£o
        function formatCPF(cpf) {
            if (cpf.length === 11) {
                return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        // Cadastra novo usu√°rio
        async function verificarOuCriarUsuario(){
            if(etapa !== 1) return;
            const nome = document.getElementById('nome-pessoa').value.trim();
            const cpfFmt = document.getElementById('cpf-pessoa').value.trim();
            const matricula = document.getElementById('matricula-pessoa').value.trim();
            const email = document.getElementById('email-pessoa').value.trim();
            if(!nome || !cpfFmt || !matricula){
                showMessage('Preencha nome, CPF e matr√≠cula.', 'error');
                return;
            }
            const cpf = cpfFmt.replace(/\D/g,'');
            if(cpf.length !== 11){
                showMessage('CPF inv√°lido.', 'error');
                return;
            }
            try {
                setLoading(true);
                const resp = await fetch('/api/usuario_status', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ nome, cpf, matricula, email })
                });
                const data = await resp.json();
                if(!data.success){
                    showMessage(data.message || 'Falha na verifica√ß√£o', 'error');
                    return;
                }
                usuarioAtualId = data.usuario_id;
                cpfAtual = data.cpf;
                etapa = 2;
                document.getElementById('etapa').textContent = 'Etapa 2 de 2 ‚Äî Captura de fotos';
                // Alterna pain√©is
                document.getElementById('form-panel').style.display='none';
                document.getElementById('capture-panel').style.display='block';
                document.getElementById('btn-capturar').disabled = false;
                document.getElementById('btn-finalizar').disabled = false;
                document.getElementById('btn-reset').style.display='inline-block';
                showMessage(data.message, 'success');
                // Inicializa c√¢mera
                initCamera();
            } catch(err){
                showMessage('Erro na comunica√ß√£o com o servidor', 'error');
            } finally { setLoading(false); }
        }

        // Captura foto
        async function capturarFoto(){
            if(!usuarioAtualId){ showMessage('Primeiro conclua etapa 1.', 'error'); return; }
            try {
                setLoading(true);
                const resp = await fetch('/api/capturar_foto', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ usuario_id: usuarioAtualId })
                });
                const data = await resp.json();
                if(!data.success){ showMessage(data.message || 'Erro ao capturar', 'error'); return; }
                fotosCapturadas = data.count;
                updateCaptureCounter();
                showMessage('Foto salva com sucesso.', 'success');
                loadPessoasRegistradas();
            } catch(err){
                showMessage('Erro de comunica√ß√£o ao capturar', 'error');
            } finally { setLoading(false); }
        }

        // Atualiza contador de fotos
        function updateCaptureCounter(){
            const el = document.getElementById('capture-counter');
            el.textContent = `${fotosCapturadas} foto(s) capturada(s).`;
            if(fotosCapturadas >= 15){ el.textContent += ' Quantidade ideal atingida.'; }
            else if(fotosCapturadas >= 10){ el.textContent += ' M√≠nimo recomendado atingido.'; }
        }

        // Mostra mensagem de status
        function showMessage(msg, kind){
            const box = document.getElementById('status-messages');
            box.innerHTML = '';
            const el = document.createElement('div');
            el.className = 'status '+(kind==='error'?'error':(kind==='success'?'success':''));
            el.textContent = msg;
            box.appendChild(el);
            setTimeout(()=>{ if(box.contains(el)) box.removeChild(el); }, 6000);
        }

        function setLoading(flag){
            const btnVerificar = document.getElementById('btn-verificar');
            if(flag){ btnVerificar.textContent = 'Processando...'; btnVerificar.disabled = true; }
            else { btnVerificar.textContent = 'Verificar / Continuar'; btnVerificar.disabled = false; }
        }

        // Resetar formul√°rio
        function resetCadastro(){
            // Para a c√¢mera se estiver ativa
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            usuarioAtualId = null; cpfAtual=null; fotosCapturadas=0; etapa=1;
            document.getElementById('form-cadastro').reset();
            document.getElementById('etapa').textContent = 'Etapa 1 de 2 ‚Äî Dados do volunt√°rio';
            document.getElementById('form-panel').style.display='block';
            document.getElementById('capture-panel').style.display='none';
            document.getElementById('btn-reset').style.display='none';
            document.getElementById('status-messages').innerHTML='';
            document.getElementById('capture-counter').textContent='Nenhuma foto capturada ainda.';
        }

        // Permite Enter para cadastrar
        document.getElementById('form-cadastro').addEventListener('submit', e => { e.preventDefault(); verificarOuCriarUsuario(); });
        document.getElementById('btn-verificar').addEventListener('click', verificarOuCriarUsuario);
        document.getElementById('btn-capturar').addEventListener('click', capturarFoto);
        document.getElementById('btn-reset').addEventListener('click', resetCadastro);
        document.getElementById('btn-finalizar').addEventListener('click', async () => {
            if(fotosCapturadas < 5){
                showMessage('Capture pelo menos 5 fotos antes de finalizar.', 'error');
                return;
            }
            // Exibe overlay de treinamento
            const overlay = document.getElementById('overlay-training');
            const trainingText = document.getElementById('training-text');
            overlay.classList.remove('hidden');
            overlay.setAttribute('aria-hidden','false');
            trainingText.textContent = 'Iniciando re-treinamento do modelo...';

            // Desabilita bot√µes durante opera√ß√£o
            const btnFinalizar = document.getElementById('btn-finalizar');
            const btnCapturar = document.getElementById('btn-capturar');
            btnFinalizar.disabled = true; btnCapturar.disabled = true;
            showMessage('Recriando modelo com novas imagens...', 'success');

            try {
                const start = Date.now();
                const resp = await fetch('/api/recriar_modelo', { method:'POST' });
                const data = await resp.json();
                const elapsed = ((Date.now() - start)/1000).toFixed(1);
                if(data.success){
                    trainingText.textContent = `Modelo atualizado em ${elapsed}s. Redirecionando...`;
                    showMessage(data.message || 'Modelo atualizado.', 'success');
                    setTimeout(()=>{ window.location.href="{{ url_for('index') }}"; }, 1300);
                } else {
                    overlay.classList.add('hidden');
                    overlay.setAttribute('aria-hidden','true');
                    btnFinalizar.disabled = false; btnCapturar.disabled = false;
                    showMessage(data.message || 'Falha ao atualizar modelo.', 'error');
                }
            } catch(err){
                overlay.classList.add('hidden');
                overlay.setAttribute('aria-hidden','true');
                btnFinalizar.disabled = false; btnCapturar.disabled = false;
                showMessage('Erro ao comunicar com servidor para treinar modelo.', 'error');
            }
        });

        // Adiciona bot√£o de reset
        document.addEventListener('DOMContentLoaded', () => { loadPessoasRegistradas(); });
    </script>
</body>
</html>