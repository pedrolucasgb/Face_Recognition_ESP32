<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Pessoas - Sistema de Reconhecimento Facial</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .video-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .video-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }

        #video-stream {
            width: 100%;
            height: auto;
            display: block;
        }

        .registration-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            min-width: 120px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-disabled:hover {
            transform: none;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .capture-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .capture-counter {
            text-align: center;
            font-size: 1.2rem;
            color: #667eea;
            margin: 10px 0;
        }

        .pessoas-registradas {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .pessoa-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .pessoa-nome {
            font-weight: bold;
            color: #333;
        }

        .pessoa-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .instructions {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .instructions h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .instructions ul {
            color: #6c757d;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ Registro de Pessoas</h1>
            <p>Sistema de Reconhecimento Facial</p>
        </div>

        <div class="nav-links">
            <a href="/">üè† In√≠cio</a>
            <a href="/registro">‚ûï Registrar Pessoa</a>
        </div>

        <div class="main-content">
            <div class="video-section">
                <h3>üìπ Visualiza√ß√£o da C√¢mera</h3>
                <div class="video-container">
                    <img id="video-stream" src="{{ url_for('video_feed_registro') }}" alt="Stream da Webcam para Registro">
                </div>
                
                <div class="instructions">
                    <h4>üìã Instru√ß√µes:</h4>
                    <ul>
                        <li>Posicione seu rosto centralizado na c√¢mera</li>
                        <li>Certifique-se de que apenas uma pessoa est√° vis√≠vel</li>
                        <li>Mantenha boa ilumina√ß√£o no ambiente</li>
                        <li>Capture pelo menos 10-15 fotos em √¢ngulos diferentes</li>
                        <li>Varie levemente a posi√ß√£o e express√£o</li>
                    </ul>
                </div>
            </div>

            <div class="registration-section">
                <h3>‚ûï Registrar Nova Pessoa</h3>
                
                <div class="form-group">
                    <label for="nome-pessoa">Nome da Pessoa:</label>
                    <input type="text" id="nome-pessoa" placeholder="Digite o nome completo">
                </div>

                <div class="capture-info">
                    <strong>üìä Status da Captura:</strong>
                    <div class="capture-counter" id="capture-counter">0 fotos capturadas</div>
                </div>

                <div class="btn-container">
                    <button class="btn btn-primary" id="btn-criar-pasta" onclick="criarPasta()">
                        üìÅ Criar Pasta
                    </button>
                    <button class="btn btn-success btn-disabled" id="btn-capturar" onclick="capturarFoto()" disabled>
                        üì∏ Capturar Foto
                    </button>
                </div>

                <div id="status-messages"></div>
            </div>
        </div>

        <div class="pessoas-registradas">
            <h3>üë• Pessoas J√° Registradas</h3>
            <div id="pessoas-lista">
                <div class="status-message status-info">Carregando pessoas registradas...</div>
            </div>
        </div>
    </div>

    <script>
        let pessoaAtual = '';
        let fotosCapturadas = 0;

        // Carrega pessoas registradas
        async function loadPessoasRegistradas() {
            try {
                const response = await fetch('/api/pessoas_registradas');
                const pessoas = await response.json();
                const container = document.getElementById('pessoas-lista');
                
                if (pessoas.length > 0) {
                    container.innerHTML = pessoas.map(pessoa => 
                        `<div class="pessoa-item">
                            <span class="pessoa-nome">${pessoa.nome}</span>
                            <span class="pessoa-count">${pessoa.imagens} fotos</span>
                        </div>`
                    ).join('');
                } else {
                    container.innerHTML = '<div class="status-message status-info">Nenhuma pessoa registrada ainda</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar pessoas:', error);
                document.getElementById('pessoas-lista').innerHTML = 
                    '<div class="status-message status-error">Erro ao carregar pessoas registradas</div>';
            }
        }

        // Cria pasta para nova pessoa
        async function criarPasta() {
            const nome = document.getElementById('nome-pessoa').value.trim();
            
            if (!nome) {
                showMessage('Por favor, digite um nome v√°lido', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/registrar_pessoa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome: nome })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    pessoaAtual = nome;
                    fotosCapturadas = 0;
                    updateCaptureCounter();
                    
                    // Habilita bot√£o de captura
                    const btnCapturar = document.getElementById('btn-capturar');
                    btnCapturar.disabled = false;
                    btnCapturar.classList.remove('btn-disabled');
                    
                    // Desabilita bot√£o de criar pasta
                    const btnCriar = document.getElementById('btn-criar-pasta');
                    btnCriar.disabled = true;
                    btnCriar.classList.add('btn-disabled');
                    
                    showMessage(`‚úÖ ${result.message}`, 'success');
                    loadPessoasRegistradas(); // Recarrega lista
                } else {
                    showMessage(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erro ao criar pasta: ' + error.message, 'error');
            }
        }

        // Captura foto
        async function capturarFoto() {
            if (!pessoaAtual) {
                showMessage('‚ùå Primeiro crie uma pasta para a pessoa', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/capturar_foto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome: pessoaAtual })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    fotosCapturadas = result.count;
                    updateCaptureCounter();
                    showMessage(`üì∏ ${result.message}`, 'success');
                    
                    // Atualiza lista de pessoas
                    loadPessoasRegistradas();
                } else {
                    showMessage(`‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Erro ao capturar foto: ' + error.message, 'error');
            }
        }

        // Atualiza contador de fotos
        function updateCaptureCounter() {
            const counter = document.getElementById('capture-counter');
            counter.textContent = `${fotosCapturadas} fotos capturadas`;
            
            if (fotosCapturadas >= 15) {
                counter.style.color = '#28a745';
                counter.innerHTML += ' ‚úÖ (Suficiente para bom reconhecimento)';
            } else if (fotosCapturadas >= 10) {
                counter.style.color = '#ffc107';
                counter.innerHTML += ' ‚ö†Ô∏è (M√≠nimo recomendado atingido)';
            }
        }

        // Mostra mensagem de status
        function showMessage(message, type) {
            const container = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            
            // Remove mensagens anteriores
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Remove mensagem ap√≥s 5 segundos
            setTimeout(() => {
                if (container.contains(messageDiv)) {
                    container.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Resetar formul√°rio
        function resetForm() {
            pessoaAtual = '';
            fotosCapturadas = 0;
            document.getElementById('nome-pessoa').value = '';
            updateCaptureCounter();
            
            // Reabilita bot√£o de criar pasta
            const btnCriar = document.getElementById('btn-criar-pasta');
            btnCriar.disabled = false;
            btnCriar.classList.remove('btn-disabled');
            
            // Desabilita bot√£o de captura
            const btnCapturar = document.getElementById('btn-capturar');
            btnCapturar.disabled = true;
            btnCapturar.classList.add('btn-disabled');
            
            document.getElementById('status-messages').innerHTML = '';
        }

        // Permite Enter para criar pasta
        document.getElementById('nome-pessoa').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('btn-criar-pasta').disabled) {
                criarPasta();
            }
        });

        // Adiciona bot√£o de reset
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.querySelector('.btn-container');
            const resetBtn = document.createElement('button');
            resetBtn.className = 'btn btn-primary';
            resetBtn.textContent = 'üîÑ Nova Pessoa';
            resetBtn.onclick = resetForm;
            container.appendChild(resetBtn);
            
            // Carrega pessoas ao inicializar
            loadPessoasRegistradas();
        });

        // Detecta erros no stream de v√≠deo
        document.getElementById('video-stream').onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzY2NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm8gYW8gY2FycmVnYXIgdmlkZW88L3RleHQ+Cjwvc3ZnPgo=';
        };
    </script>
</body>
</html>